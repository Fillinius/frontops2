document.addEventListener('DOMContentLoaded', start)
let FILMS = []
const LOCALSTORAGE_KEY = 'films'

function getArrayFilms() {
  const URL = 'https://www.omdbapi.com/?s=marvel&apikey=9b67fc54'
  fetch(URL)
    .then((response) => response.json())
    .then((data) => {
      FILMS = formatResponseArray(data)
      render()
    })
    .catch((err) => console.log(err))
}

function formatResponseArray(data) {
  return data.Search.map((film) => {
    let filmFoundFromStorage = getLocalstorage(LOCALSTORAGE_KEY)
    const isLiked = filmFoundFromStorage[film.imdbID]?.liked
    return {
      ...film,
      liked: isLiked,
    }
  })
}

function render() {
  const filmEl = document.querySelector('.films')
  const findFavoritePage = new URL(window.location)
  console.log(findFavoritePage)
  filmEl.innerHTML = ''
  filmEl.innerHTML = FILMS.map((film) => {
    let urlLiked = film.liked ? './images/Like.png' : './images/unLike.png'
    return `
    <div class="card" onclick=liked(event)>
              <img
                class="card__img"
                src="${film.Poster}"
                alt="poster"
              />
              <a class="card__title" href="/">${film.Title}</a>
              <p class="card__year">${film.Year}</p>
              <button class="card__btn" data-btn-img=${film.imdbID}>
                <img class="card__btn-img" src=${urlLiked} alt="" />
              </button>
            </div>
    `
  }).join('')
  console.log(FILMS)
}

function liked(event) {
  const { target } = event
  const filmId = target.parentElement.dataset.btnImg
  if (filmId) {
    FILMS = FILMS.map((film) => {
      return {
        ...film,
        liked: filmId === film.imdbID ? !film.liked : film.liked,
      }
    })
  }
  render()
  let filmFoundFromStorage = getLocalstorage(LOCALSTORAGE_KEY)
  const filmFoundById = FILMS.find((film) => film.imdbID === filmId)
  if (filmFoundById) {
    filmFoundFromStorage = {
      ...filmFoundFromStorage,
      [filmId]: {
        ...filmFoundById,
        liked: filmFoundById.liked,
      },
    }
    setLocalstorage(LOCALSTORAGE_KEY, filmFoundFromStorage)
  }
}
function setLocalstorage(key, data) {
  localStorage.setItem(key, JSON.stringify(data))
}
function getLocalstorage(key) {
  return JSON.parse(localStorage.getItem(key))
}

function start() {
  getArrayFilms()
  render()
}
